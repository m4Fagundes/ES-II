<div class="space-y-8 animate-fade-in pb-10">
    <h3 class="text-2xl font-bold text-slate-800 flex items-center gap-3">
        <div class="w-10 h-10 bg-green-100 text-green-600 rounded-xl flex items-center justify-center">
            <i class="ph-bold ph-chart-line-up text-xl"></i>
        </div>
        Gestão Financeira
    </h3>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-slate-900 text-white p-6 rounded-[2rem] shadow-xl relative overflow-hidden">
            <div class="absolute top-0 right-0 p-4 opacity-10">
                <i class="ph-fill ph-currency-dollar text-8xl text-white"></i>
            </div>
            <div class="relative z-10">
                <div class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-1">Receita Mensal</div>
                <div class="text-4xl font-black" id="fin-receita">R$ --</div>
                <div class="text-green-400 text-xs font-bold mt-2 flex items-center gap-1">
                    <i class="ph-bold ph-trend-up"></i> Calculado hoje
                </div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-[2rem] border border-slate-200 shadow-sm">
            <div class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-2">Total Assinantes</div>
            <div class="text-4xl font-black text-slate-800" id="fin-users">--</div>
            <div class="text-sm text-slate-500 mt-1">Clientes ativos na base</div>
        </div>

        <div class="bg-white p-6 rounded-[2rem] border border-slate-200 shadow-sm">
            <div class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-2">Ticket Médio</div>
            <div class="text-4xl font-black text-slate-800" id="fin-ticket">R$ --</div>
            <div class="text-sm text-slate-500 mt-1">Receita / Usuários</div>
        </div>
    </div>

    <div class="bg-white p-8 rounded-2xl border border-slate-200 shadow-sm">
        <h4 class="font-bold text-slate-800 mb-6">Planos mais vendidos</h4>
        <div id="lista-planos" class="space-y-4">
            <div class="animate-pulse h-10 bg-slate-100 rounded-lg"></div>
        </div>
    </div>
</div>

<script>
    // IIFE para isolar o escopo, mas executar imediatamente ao carregar
    (async function initFinanceiro() {
        const token = localStorage.getItem('token');
        const API_URL = 'http://127.0.0.1:8000';

        try {
            const res = await fetch(`${API_URL}/admin/planos/financeiro`, {
                headers: { 'X-Token': token }
            });
            
            // Tratamento de Permissão
            if (res.status === 403) {
                document.querySelector('.animate-fade-in').innerHTML = `
                    <div class="flex flex-col items-center justify-center h-64 text-center">
                        <i class="ph-duotone ph-lock-key text-6xl text-red-300 mb-4"></i>
                        <h3 class="text-xl font-bold text-slate-700">Acesso Restrito</h3>
                        <p class="text-slate-500">Apenas administradores podem ver esta tela.</p>
                    </div>`;
                return;
            }

            if (!res.ok) throw new Error('Erro ao buscar dados');

            const data = await res.json();

            // Atualiza KPIs
            document.getElementById('fin-receita').innerText = data.total_receita_mensal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            document.getElementById('fin-users').innerText = data.total_assinantes;
            document.getElementById('fin-ticket').innerText = data.ticket_medio.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

            // Gera Lista Visual
            const container = document.getElementById('lista-planos');
            let html = '';
            
            const entries = Object.entries(data.planos_vendidos).sort((a,b) => b[1] - a[1]);
            const maxVal = entries.length > 0 ? entries[0][1] : 1;

            if (entries.length === 0) {
                html = '<div class="text-slate-400 text-center py-4">Nenhuma venda registrada ainda.</div>';
            } else {
                entries.forEach(([nome, qtd]) => {
                    const pct = (qtd / maxVal) * 100;
                    html += `
                    <div>
                        <div class="flex justify-between text-sm font-bold text-slate-700 mb-1">
                            <span>${nome}</span>
                            <span>${qtd} un.</span>
                        </div>
                        <div class="w-full bg-slate-100 rounded-full h-3 overflow-hidden">
                            <div class="bg-green-500 h-full rounded-full transition-all duration-1000" style="width: ${pct}%"></div>
                        </div>
                    </div>`;
                });
            }
            container.innerHTML = html;

        } catch (e) {
            console.error(e);
            alert('Erro ao carregar dados financeiros. Verifique o console.');
        }
    })();
</script>